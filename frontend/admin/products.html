<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script>
        // Immediate redirect to login if not authenticated
        (function () {
            const isLoggedIn = sessionStorage.getItem('isAdminLoggedIn');
            if (!isLoggedIn) {
                window.location.replace('login.html');
            }
        })();
    </script>
    <script src="js/authGuard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - OnLiNE ELECTRONICS Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body class="admin">
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>OnLiNE ELECTRONICS</h2>
                <span>Admin Panel</span>
            </div>
            <nav class="admin-nav">
                <ul>
                    <li>
                        <a href="index.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="products.html">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li>
                        <a href="users.html">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logoutButton">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Products</h1>
                </div>
                <div class="header-right">

                    <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">All Products</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="productsTable" class="table table-striped" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="needs-validation" novalidate>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="productName" required>
                                    <div class="invalid-feedback">
                                        Please provide a product name.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productSku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="productSku" required>
                                    <div class="invalid-feedback">
                                        Please provide a SKU.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Category</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">Select a category</option>
                                        <option value="smartphones">Smartphones</option>
                                        <option value="laptops">Laptops</option>
                                        <option value="tablets">Tablets</option>
                                        <option value="audio">Audio</option>
                                        <option value="wearables">Wearables</option>
                                        <option value="accessories">Accessories</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a category.
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="productPrice" class="form-label">Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="productPrice" min="0"
                                                step="0.01" required>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please provide a valid price.
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="productStock" class="form-label">Stock</label>
                                        <input type="number" class="form-control" id="productStock" min="0" required>
                                        <div class="invalid-feedback">
                                            Please provide stock quantity.
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="productStatus" checked>
                                    <label class="form-check-label" for="productStatus">Active</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Images</label>
                                    <div class="image-upload-container mb-3">
                                        <div class="image-preview-container">
                                            <div class="image-preview" id="imagePreview">
                                                <img src="https://via.placeholder.com/150" alt="Preview"
                                                    class="img-thumbnail" id="imagePreviewElement">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <input type="file" class="form-control" id="productImage" accept="image/*"
                                                required>
                                            <div class="invalid-feedback">
                                                Please upload a product image.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="productDescription" rows="5" required></textarea>
                                    <div class="invalid-feedback">
                                        Please provide a product description.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="needs-validation" novalidate id="editProductForm">
                    <div class="modal-body">
                        <input type="hidden" id="editProductId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductName" class="form-label">Product Name</label>
                                    <input type="text" class="form-control" id="editProductName" required>
                                    <div class="invalid-feedback">
                                        Please provide a product name.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editProductSku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="editProductSku" required>
                                    <div class="invalid-feedback">
                                        Please provide a SKU.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editProductCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editProductCategory" required>
                                        <option value="">Select a category</option>
                                        <option value="smartphones">Smartphones</option>
                                        <option value="laptops">Laptops</option>
                                        <option value="tablets">Tablets</option>
                                        <option value="audio">Audio</option>
                                        <option value="wearables">Wearables</option>
                                        <option value="accessories">Accessories</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a category.
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editProductPrice" class="form-label">Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="editProductPrice" min="0"
                                                step="0.01" required>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please provide a valid price.
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editProductStock" class="form-label">Stock</label>
                                        <input type="number" class="form-control" id="editProductStock" min="0"
                                            required>
                                        <div class="invalid-feedback">
                                            Please provide stock quantity.
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="editProductStatus" checked>
                                    <label class="form-check-label" for="editProductStatus">Active</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Images</label>
                                    <div class="image-upload-container mb-3">
                                        <div class="image-preview-container">
                                            <div class="image-preview" id="editImagePreview">
                                                <img src="https://via.placeholder.com/150" alt="Preview"
                                                    class="img-thumbnail" id="editImagePreviewElement">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <input type="file" class="form-control" id="editProductImage"
                                                accept="image/*">
                                            <small class="text-muted">Leave empty to keep current image</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editProductDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editProductDescription" rows="5"
                                        required></textarea>
                                    <div class="invalid-feedback">
                                        Please provide a product description.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                    <p class="mb-0"><strong>Product:</strong> <span id="productToDelete"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
    <script type="module">
        let productsTable;
        let imageBase64 = null;

        async function fetchProducts() {
            const res = await fetch('http://localhost:5000/api/products');
            return await res.json();
        }

        async function renderProducts() {
            const products = await fetchProducts();
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';

            if (productsTable) {
                productsTable.destroy();
            }

            products.forEach(product => {
                const stockStatus = product.stock > 10 ? 'in-stock' : (product.stock > 0 ? 'low-stock' : 'out-of-stock');
                const stockText = product.stock > 10 ? 'In Stock' : (product.stock > 0 ? 'Low Stock' : 'Out of Stock');

                const imageUrl = product.image_url ?
                    (product.image_url.startsWith('http') ? product.image_url : `http://localhost:5000${product.image_url}`) :
                    'https://via.placeholder.com/50';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${imageUrl}" alt="${product.name}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;"></td>
                    <td>${product.name}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>$${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.stock || 0}</td>
                    <td><span class="status ${stockStatus}">${stockText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-btn" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                // Set data attributes properly using DOM properties
                const editBtn = row.querySelector('.edit-btn');
                const deleteBtn = row.querySelector('.delete-btn');

                editBtn.dataset.id = product.id;
                deleteBtn.dataset.id = product.id;
                deleteBtn.dataset.name = product.name;

                tableBody.appendChild(row);
            });

            productsTable = new DataTable('#productsTable', {
                responsive: true,
                order: [[1, 'asc']],
                columnDefs: [
                    { orderable: false, targets: [0, 6] }
                ]
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const addProductForm = document.querySelector('#addProductModal form');
            const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
            const deleteProductModal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
            let productIdToDelete = null;

            // Initial render
            renderProducts();

            // Handle Add Product form submission
            addProductForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!addProductForm.checkValidity()) {
                    event.stopPropagation();
                    addProductForm.classList.add('was-validated');
                    return;
                }
                const name = document.getElementById('productName').value;
                const description = document.getElementById('productDescription').value;
                const price = document.getElementById('productPrice').value;
                const sku = document.getElementById('productSku').value;
                const category = document.getElementById('productCategory').value;
                const stock = document.getElementById('productStock').value;
                const status = document.getElementById('productStatus').checked;

                // First upload the image file (if present) using multipart/form-data
                const imageInput = document.getElementById('productImage');
                let imageUrl = null;
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    const formData = new FormData();
                    formData.append('image', imageInput.files[0]);
                    const token = localStorage.getItem('adminToken');

                    // Use explicit backend URL to avoid hitting Live Server by mistake
                    const uploadUrl = 'http://127.0.0.1:5000/api/upload';
                    console.log('Uploading image to', uploadUrl, 'file size:', imageInput.files[0].size);
                    let uploadRes;
                    try {
                        console.log('Authorization token present?', !!token);
                        uploadRes = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                            body: formData,
                            mode: 'cors'
                        });
                    } catch (err) {
                        console.error('Network error uploading image', err);
                        alert('Image upload failed (network error): ' + err.message);
                        return;
                    }

                    const contentType = uploadRes.headers.get('content-type') || '';
                    if (!uploadRes.ok) {
                        let text = await uploadRes.text();
                        console.error('Upload failed', uploadRes.status, text);
                        if (contentType.includes('text/html')) {
                            alert('Image upload failed: server returned HTML error. Check backend is running on port 5000.');
                        } else {
                            alert('Image upload failed: ' + text);
                        }
                        return;
                    }
                    const uploadData = await uploadRes.json();
                    imageUrl = uploadData.url;
                }

                const newProduct = {
                    name,
                    description,
                    price: parseFloat(price),
                    image_url: imageUrl,
                    sku,
                    category,
                    stock: parseInt(stock) || 0,
                    status
                };

                // Attach admin JWT from localStorage so backend authorizeAdmin middleware accepts the request
                const token2 = localStorage.getItem('adminToken');
                const res = await fetch('http://localhost:5000/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token2 ? { 'Authorization': 'Bearer ' + token2 } : {})
                    },
                    body: JSON.stringify(newProduct)
                });

                if (!res.ok) {
                    // If unauthorized, redirect to login so user can authenticate
                    if (res.status === 401 || res.status === 403) {
                        alert('You are not authorized. Please login as admin.');
                        window.location.href = 'login.html';
                        return;
                    }
                    const err = await res.json().catch(() => ({}));
                    alert('Failed to add product: ' + (err.error || res.statusText));
                    return;
                }
                await renderProducts();
                addProductModal.hide();
                addProductForm.reset();
                addProductForm.classList.remove('was-validated');
                imageBase64 = null;
                document.getElementById('imagePreviewElement').src = 'https://via.placeholder.com/150';
            });

            // Handle image preview and conversion
            document.getElementById('productImage').addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('imagePreviewElement').src = e.target.result;
                        imageBase64 = e.target.result; // Store base64 string
                    }
                    reader.readAsDataURL(file);
                }
            });

            // Handle edit and delete button clicks with event delegation
            document.getElementById('productsTableBody').addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const productId = editBtn.dataset.id;
                    console.log('Edit button clicked. Product ID:', productId, 'Type:', typeof productId);
                    console.log('Button element:', editBtn);
                    await openEditModal(productId);
                } else if (deleteBtn) {
                    const productId = deleteBtn.dataset.id;
                    const productName = deleteBtn.dataset.name;
                    console.log('Delete button clicked. Product ID:', productId, 'Type:', typeof productId);
                    console.log('Product Name:', productName);
                    console.log('Button element:', deleteBtn);
                    openDeleteModal(productId, productName);
                }
            });

            // Handle edit form submission
            document.getElementById('editProductForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!event.target.checkValidity()) {
                    event.stopPropagation();
                    event.target.classList.add('was-validated');
                    return;
                }

                const productId = document.getElementById('editProductId').value;
                const name = document.getElementById('editProductName').value;
                const description = document.getElementById('editProductDescription').value;
                const price = document.getElementById('editProductPrice').value;
                const sku = document.getElementById('editProductSku').value;
                const category = document.getElementById('editProductCategory').value;
                const stock = document.getElementById('editProductStock').value;
                const status = document.getElementById('editProductStatus').checked;

                // Handle image upload if new image is selected
                const imageInput = document.getElementById('editProductImage');
                let imageUrl = document.getElementById('editImagePreviewElement').src;

                if (imageInput && imageInput.files && imageInput.files[0]) {
                    const formData = new FormData();
                    formData.append('image', imageInput.files[0]);
                    const token = localStorage.getItem('adminToken');

                    try {
                        const uploadRes = await fetch('http://localhost:5000/api/upload', {
                            method: 'POST',
                            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                            body: formData
                        });

                        if (!uploadRes.ok) {
                            const text = await uploadRes.text();
                            alert('Image upload failed: ' + text);
                            return;
                        }
                        const uploadData = await uploadRes.json();
                        imageUrl = uploadData.url;
                    } catch (err) {
                        alert('Image upload failed: ' + err.message);
                        return;
                    }
                }

                const updatedProduct = {
                    name,
                    description,
                    price: parseFloat(price),
                    image_url: imageUrl.includes('placeholder') ? null : imageUrl,
                    sku,
                    category,
                    stock: parseInt(stock) || 0,
                    status
                };

                const token = localStorage.getItem('adminToken');
                try {
                    const res = await fetch(`http://localhost:5000/api/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                        },
                        body: JSON.stringify(updatedProduct)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        alert('Failed to update product: ' + (err.error || res.statusText));
                        return;
                    }

                    await renderProducts();
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                    editModal.hide();
                    event.target.reset();
                    event.target.classList.remove('was-validated');
                    alert('Product updated successfully!');
                } catch (err) {
                    alert('Failed to update product: ' + err.message);
                }
            });

            // Handle delete confirmation
            document.getElementById('confirmDelete').addEventListener('click', async () => {
                const productId = document.getElementById('confirmDelete').dataset.productId;
                const token = localStorage.getItem('adminToken');

                console.log('Confirm delete clicked. Product ID from dataset:', productId);
                console.log('Product ID type:', typeof productId);
                console.log('Token exists:', !!token);

                if (!productId) {
                    alert('Error: Product ID is missing');
                    return;
                }

                try {
                    const url = `http://localhost:5000/api/products/${productId}`;
                    console.log('Sending DELETE request to:', url);

                    const res = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                        }
                    });

                    console.log('Response status:', res.status);
                    console.log('Response ok:', res.ok);

                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error('Delete failed. Status:', res.status, 'Response:', errorText);
                        alert(`Failed to delete product: ${res.status} - ${errorText}`);
                        return;
                    }

                    const result = await res.json();
                    console.log('Delete successful:', result);

                    await renderProducts();
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteProductModal'));
                    deleteModal.hide();
                    alert('Product deleted successfully!');
                } catch (err) {
                    console.error('Error in delete:', err);
                    alert('Failed to delete product: ' + err.message);
                }
            });

            // Handle edit image preview
            document.getElementById('editProductImage').addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('editImagePreviewElement').src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        });

        // Function to open edit modal with product data
        async function openEditModal(productId) {
            console.log('Opening edit modal for product ID:', productId);
            try {
                const token = localStorage.getItem('adminToken');
                const res = await fetch(`http://localhost:5000/api/products/${productId}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
                    }
                });

                console.log('Fetch response status:', res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Fetch error:', res.status, errorText);
                    alert(`Failed to fetch product details: ${res.status} - ${errorText}`);
                    return;
                }

                const product = await res.json();
                console.log('Product data received:', product);

                // Populate form fields
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name || '';
                document.getElementById('editProductSku').value = product.sku || '';
                document.getElementById('editProductCategory').value = product.category || '';
                document.getElementById('editProductPrice').value = product.price || '';
                document.getElementById('editProductStock').value = product.stock || 0;
                document.getElementById('editProductStatus').checked = product.status !== false;
                document.getElementById('editProductDescription').value = product.description || '';

                // Set image preview
                const imageUrl = product.image_url ?
                    (product.image_url.startsWith('http') ? product.image_url : `http://localhost:5000${product.image_url}`) :
                    'https://via.placeholder.com/150';
                document.getElementById('editImagePreviewElement').src = imageUrl;

                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
                editModal.show();
            } catch (err) {
                console.error('Error in openEditModal:', err);
                alert('Failed to load product: ' + err.message);
            }
        }

        // Function to open delete modal
        function openDeleteModal(productId, productName) {
            console.log('Opening delete modal with ID:', productId, 'Name:', productName);
            document.getElementById('productToDelete').textContent = productName;
            document.getElementById('confirmDelete').dataset.productId = productId;

            // Verify the ID was set
            console.log('Confirm button dataset.productId:', document.getElementById('confirmDelete').dataset.productId);

            const deleteModal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
            deleteModal.show();
        }
    </script>
</body>

</html>